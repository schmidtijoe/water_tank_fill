<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <style>
      body {background-color: #1b1f19;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

    <title>Zisterne F체llstand</title>
  </head>
  <body>
    <h1 style="color: #d6c67c;">F&uumlllstand </h1>

    <p style="color: #d6c67c;">
      Letzter Eintrag: <span id="entry"></span><br />
    </p>

    <div class="aspect-ratio">
      <canvas id="bar" width="100" height="10"></canvas>

      <br></br>
      <br></br>
      <br></br>

      <canvas id="chart" width="100" height="40"></canvas>
    </div>
    <script>
      const data_url = 'data.json';
      const ctx = document.getElementById('chart').getContext('2d');
      const cty = document.getElementById('bar').getContext('2d');

      async function getData() {
        const dates = [];
        const fill_percentage = [];
        const temperatures = [];
        const response = await fetch(data_url);
        console.log(response);
        const data = await response.json();
        console.log(data);
        for (i = 0; i < data.length; i++) {
          dates.push(data[i].date);
          temperatures.push(parseFloat(data[i].temperature).toFixed(2));
          fill_percentage.push(parseFloat(data[i].fill_percentage).toFixed(2));
        }
        document.getElementById("entry").textContent = dates[dates.length -1];
        return {dates, temperatures, fill_percentage};
        }

      async function plotit() {
        const gradient1 = ctx.createLinearGradient(0, 0, 0, 350);
        gradient1.addColorStop(0, 'rgba(172, 120, 227, 0.6)') // show this color at 0%;
        gradient1.addColorStop(0.5, 'rgba(172, 120, 227, 0.3)'); // show this color at 50%
        gradient1.addColorStop(1, 'rgba(172, 120, 227, 0)'); // show this color at 100%

        const gradient2 = ctx.createLinearGradient(0, 0, 0, 350);
        gradient2.addColorStop(0, 'rgba(227, 193, 120, 0.6)') // show this color at 0%;
        gradient2.addColorStop(0.5, 'rgba(227, 193, 120, 0.3)'); // show this color at 50%
        gradient2.addColorStop(1, 'rgba(227, 193, 120, 0)'); // show this color at 100%

        const data = await getData();
        const volume = data.fill_percentage[data.fill_percentage.length - 1] * 30;

        const plot = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.dates,
            datasets: [{
              label: 'Zisterne F체llstand',
              backgroundColor: gradient1,
              borderColor: '#9c14fc',
              borderWidth: 5,
              data: data.fill_percentage,
              yAxisID: 'perc'
              },
              {
              label: 'Zisterne Temperatur',
              backgroundColor: gradient2,
              borderColor: '#d19d2e',
              borderWidth: 5,
              data: data.temperatures,
              yAxisID: 'temp'
            }]
          },
          options: {
            legend: {
              position: 'right'
            },
            scales: {
              xAxes: [{
                ticks: {
                    maxRotation: 90,
                    minRotation: 70
                }
              }],
              yAxes: [{
                id: 'perc',
                type: 'linear',
                position: 'left',
                ticks: {
                  suggestedMin: 0,
                  suggestedMax: 100,
                  stepSize: 5,
                  callback: function(value, index, values) {
                    return value + ' %'
                  },
                  fontColor: 'rgba(172, 120, 227, 0.8)'
                },
                scaleLabel: {
                  display: true,
                  labelString: 'F체llstand',
                  fontColor: 'rgba(172, 120, 227, 0.8)'
                }
              }, {
                id: 'temp',
                type: 'linear',
                position: 'right',
                ticks: {
                  callback: function(value, index, values) {
                    return value + ' 째'
                  },
                  fontColor: 'rgba(227, 193, 120, 0.8)'
                },
                scaleLabel: {
                  display: true,
                  labelString: 'Temperature',
                  fontColor: 'rgba(227, 193, 120, 0.8)'
                }
              }]
            },
            animation: {
              easing: "easeInCirc"
            },
            tooltips: {
              mode: 'nearest',
              intersect: false
            }
          }
        });

        const status = new Chart(cty, {
          type: 'doughnut',
          data: {
            labels: ['Status'],
            datasets: [{
              backgroundColor: ['rgba(17, 105, 3, 0.6)'],
              borderColor: ['rgb(62, 97, 56)', 'rgb(56, 61, 56)'],
              borderWidth: 2,
              data: [volume.toFixed(1), (3000-volume).toFixed(1)]
              }]
            },
            options: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'Status'
              },
              tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = 'aktuelles Volumen: ';

                        label += volume.toFixed(1) ;
                        return label + ' Liter';
                    }
                }
              }
            }
          });
        }

      plotit();
    </script>
  </body>
</html>
